name: ImmortalWrt-24.10

on:
  repository_dispatch:
    types: [build_firmware]
  workflow_dispatch:
    inputs:
      device_model:
        description: 'ÈÄâÊã©ÁõÆÊ†áËÆæÂ§áÂûãÂè∑'
        type: choice
        required: true
        options:
          - cmcc_rax3000m
      upload_bin_dir:
        description: '‰∏ä‰º† bin ÁõÆÂΩï'
        type: boolean
        required: true
        default: true
      upload_packages_dir:
        description: '‰∏ä‰º† packages ÁõÆÂΩï'
        type: boolean
        required: true
        default: false
      upload_all_files:
        description: '‰∏ä‰º†ÊâÄÊúâÊñá‰ª∂ÔºàÂåÖÊã¨ GPT„ÄÅpreloader„ÄÅFIP„ÄÅrecovery„ÄÅsysupgradeÔºâ'
        type: boolean
        required: true
        default: false
      repo_url:
        description: 'Ê∫ê‰ªìÂ∫ì URL'
        default: 'https://github.com/immortalwrt/immortalwrt'
        type: choice
        options:
          - 'https://github.com/immortalwrt/immortalwrt'
      repo_branch:
        description: 'Ê∫ê‰ªìÂ∫ìÂàÜÊîØ'
        default: 'openwrt-24.10'
        type: choice
        options:
          - 'openwrt-24.10'
      config_file:
        description: 'ÈÖçÁΩÆÊñá‰ª∂'
        default: '24.10.config'
        type: choice
        options:
          - '24.10.config'
      enable_keepalived:
        description: 'ÈõÜÊàê keepalived'
        type: boolean
        required: true
        default: true
      ssh:
        description: 'SSH connection to Actions'
        type: boolean
        required: true
        default: false
      # istore:
      #   description: 'ÈõÜÊàêiStoreÂïÜÂ∫ó'
      #   type: boolean
      #   required: true
      #   default: false
      # enable_openclash:
      #   description: 'ÈõÜÊàêopenclash'
      #   type: boolean
      #   required: true
      #   default: true
      # enable_wechatpush:
      #   description: 'ÈõÜÊàêwechatpush'
      #   type: boolean
      #   required: true
      #   default: true

  schedule:
    - cron: '0 6 * * 1'

permissions:
  contents: write
  actions: write

env:
  REPO_URL: ${{ github.event.inputs.repo_url || 'https://github.com/immortalwrt/immortalwrt' }}
  REPO_BRANCH: ${{ github.event.inputs.repo_branch || 'openwrt-24.10' }}
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: ${{ github.event.inputs.config_file || '24.10.config' }}
  DIY_P1_SH: scripts/24.10/diy-part1.sh
  DIY_P2_SH: scripts/24.10/diy-part2.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  BUILD_COMMIT_MSGS_FILE: ''
  CHECKED_COMMIT_MSGS_FILE: ''
  ENABLE_KEEPALIVED: ${{ github.event.inputs.enable_keepalived || 'true' }}
  ENABLE_OPENCLASH: ${{ github.event.inputs.enable_openclash || 'true' }}
  ENABLE_WECHATPUSH: ${{ github.event.inputs.enable_wechatpush || 'false' }}
  UPLOAD_ALL_FILES: ${{ github.event.inputs.upload_all_files || 'false' }}
  CCACHE_DIR: ${{ github.workspace }}/.ccache

# ============================
# Job1ÔºöÊ£ÄÊµãÊ∫ê‰ªìÂ∫ìÊõ¥Êñ∞
# ============================
jobs:
  check-source-updates:
    runs-on: ubuntu-22.04
    name: Ê£ÄÊµãÊ∫ê‰ªìÂ∫ìÊõ¥Êñ∞
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - name: Ê£ÄÂá∫Êú¨‰ªìÂ∫ì‰ª£Á†Å
        uses: actions/checkout@v4

      - name: ËÆæÁΩÆ REPO_PATH
        run: echo "REPO_PATH=$(echo $REPO_URL | sed -E 's#https://github.com/##;s#/$##')" >> $GITHUB_ENV

      - name: Ëé∑Âèñ last_checked_sha ÁºìÂ≠ò
        id: cache-sha
        uses: actions/cache@v4
        with:
          path: last_checked_sha.txt
          key: ${{ env.REPO_PATH }}-${{ env.REPO_BRANCH }}-last-checked-sha

      - name: ÂÆâË£Ö GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Ê£ÄÊü•Ê∫ê‰ªìÂ∫ìÊõ¥Êñ∞
        id: check
        continue-on-error: true
        run: |
          echo "REPO_PATH=$REPO_PATH"
          echo "REPO_BRANCH=$REPO_BRANCH"
          LATEST_URL=$(curl -s -f -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${REPO_PATH}/commits/$REPO_BRANCH" | jq -r '.url' || echo "")
          echo "Ë∑≥ËΩ¨URLÔºö$LATEST_URL"
          response=$(curl -s -f -H "Accept: application/vnd.github.v3+json" "$LATEST_URL")
          LATEST_SHA=$(echo "$response" | jq -r '.sha' || echo "")

          if [ -z "$LATEST_SHA" ] || [ "$LATEST_SHA" = "null" ]; then
            echo "Êó†Ê≥ïËé∑ÂèñÊúÄÊñ∞ SHAÔºåË∑≥ËøáÁºñËØë"
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "Ê∫ê‰ªìÂ∫ìÊúÄÊñ∞Êèê‰∫§ sha: $LATEST_SHA"
            echo "LATEST_SHA=$LATEST_SHA" >> $GITHUB_ENV

            LAST_CHECKED_FILE="last_checked_sha.txt"
            LAST_CHECKED_SHA=$(cat "$LAST_CHECKED_FILE" 2>/dev/null || echo "")

            if [ "$LATEST_SHA" != "$LAST_CHECKED_SHA" ]; then
              echo "Ê£ÄÊµãÂà∞Ê∫ê‰ªìÂ∫ìÊõ¥Êñ∞Ôºö$LATEST_SHA"
              echo "should_build=true" >> $GITHUB_OUTPUT
              echo "$LATEST_SHA" > "$LAST_CHECKED_FILE"
            else
              echo "Ê∫ê‰ªìÂ∫ìÊó†Êõ¥Êñ∞ÔºåË∑≥ËøáÁºñËØë"
              echo "should_build=false" >> $GITHUB_OUTPUT
            fi
          fi

# ==========================================
# Job2ÔºöÂü∫Á°ÄÂõ∫‰ª∂
# ==========================================
  build-base:
    needs: check-source-updates
    if: github.event_name == 'workflow_dispatch' || needs.check-source-updates.outputs.should_build == 'true'
    runs-on: ubuntu-22.04
    name: ÁºñËØë ${{ matrix.device_model }} Âõ∫‰ª∂
    strategy:
      matrix:
        device_model: ${{ github.event.inputs.device_model && fromJSON(format('["{0}"]', github.event.inputs.device_model)) || fromJSON('["cmcc_rax3000m"]') }}
      max-parallel: 1
    env:
      MATRIX_DEVICE_MODEL: ${{ matrix.device_model }}
    outputs:
      need_second_build: ${{ steps.need-second-build.outputs.NEED_SECOND_BUILD }}
    steps:
      - name: Ë∞ÉËØï‰ø°ÊÅØ
        run: |
          echo "Ëß¶ÂèëÊñπÂºè: ${{ github.event_name }}"
          echo "EVENT_TRIGGER_METHOD=${{ github.event_name }}" >> $GITHUB_ENV
          echo "ËÆæÂ§áÂûãÂè∑: ${{ matrix.device_model }}"
          echo "‰∏ä‰º† bin ÁõÆÂΩï: ${{ github.event.inputs.upload_bin_dir }}"
          echo "‰∏ä‰º† packages ÁõÆÂΩï: ${{ github.event.inputs.upload_packages_dir }}"

      - name: Âà§Êñ≠ÊòØÂê¶ÈúÄË¶ÅÁ¨¨‰∫åÊ¨°ÁºñËØë
        id: need-second-build
        run: |
          NEED_SECOND_BUILD=false

          # Âè™Ë¶ÅÊúâ‰∏Ä‰∏™ÂèØÈÄâÊèí‰ª∂ÂêØÁî®ÔºåÂ∞±ÈúÄË¶ÅÁ¨¨‰∫åÊ¨°ÁºñËØë
          if [ "$ENABLE_KEEPALIVED" = "true" ]; then NEED_SECOND_BUILD=true; fi
          if [ "$ENABLE_WECHATPUSH" = "true" ]; then NEED_SECOND_BUILD=true; fi

          echo "NEED_SECOND_BUILD=$NEED_SECOND_BUILD" >> $GITHUB_OUTPUT

      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ËæìÂá∫ÊúÄËøëÁöÑ 5 Êù°Êèê‰∫§Êó•Âøó
        run: git log -n 5

      - name: ËÆæÁΩÆ REPO_PATH
        run: echo "REPO_PATH=$(echo $REPO_URL | sed -E 's#https://github.com/##;s#/$##')" >> $GITHUB_ENV

      - name: Ëé∑Âèñ last_build_sha ÁºìÂ≠ò
        uses: actions/cache@v4
        with:
          path: last_build_sha.txt
          key: ${{ env.REPO_PATH }}-${{ env.REPO_BRANCH }}-last-build-sha

      - name: ÁîüÊàêÊú¨‰ªìÂ∫ìÊõ¥Êñ∞Êó•ÂøóÔºàÂÜôÂÖ•‰∏¥Êó∂Êñá‰ª∂Ôºâ
        run: |
          if [ -f last_build_sha.txt ]; then
            LAST_BUILD_SHA=$(cat last_build_sha.txt)
          else
            LAST_BUILD_SHA=""
          fi
          if [ -n "$LAST_BUILD_SHA" ]; then
            TEMP_FILE=$(mktemp)
            git log $LAST_BUILD_SHA..HEAD --pretty=format:"%s" | awk '!a[$0]++' | sed 's/^/- /' > "$TEMP_FILE"
            echo "BUILD_COMMIT_MSGS_FILE=$TEMP_FILE" >> $GITHUB_ENV
            echo "Êú¨‰ªìÂ∫ìÊõ¥Êñ∞‰ø°ÊÅØ:"
            cat "$TEMP_FILE"
          else
            echo "Êú¨‰ªìÂ∫ìÊó†Êõ¥Êñ∞"
          fi

      - name: Ê£ÄÊü•Á£ÅÁõòÁ©∫Èó¥
        run: |
          MIN_SPACE=10
          AVAILABLE=$(df -BG . | tail -1 | awk '{print $4}' | sed 's/G//')
          if [ -z "$AVAILABLE" ] || [ "$AVAILABLE" -lt "$MIN_SPACE" ]; then
            echo "ÈîôËØØÔºöÁ£ÅÁõòÁ©∫Èó¥‰∏çË∂≥ÔºåÂèØÁî®Á©∫Èó¥ ${AVAILABLE}GÔºåÈúÄËá≥Â∞ë ${MIN_SPACE}G"
            exit 1
          fi
          echo "ÂèØÁî®Á£ÅÁõòÁ©∫Èó¥Ôºö${AVAILABLE}G"

      - name: ÂàùÂßãÂåñÁéØÂ¢É
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo apt-get update
          sudo apt-get install -y build-essential ccache cmake curl git gawk gcc-multilib g++-multilib \
            libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev \
            libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool \
            ninja-build python3 python3-pyelftools rsync unzip vim wget zlib1g-dev jq
          sudo apt-get autoremove --purge -y
          sudo apt-get clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: Ê∏ÖÁêÜÁ£ÅÁõòÁ©∫Èó¥
        run: |
          echo ">>> Ê∏ÖÁêÜÈ¢ÑË£ÖËΩØ‰ª∂Ôºàdotnet/android/haskell/CodeQLÔºâ"
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL

          echo ">>> Ê∏ÖÁêÜ Docker"
          sudo systemctl stop docker || true
          sudo rm -rf /var/lib/docker

          echo ">>> Ê∏ÖÁêÜ APT ÁºìÂ≠ò"
          sudo apt-get clean
          sudo apt-get autoremove -y

          echo ">>> Ê∏ÖÁêÜÂ§ßÊñá‰ª∂"
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /usr/local/share/chromium
          sudo rm -rf /usr/local/share/edge

          echo ">>> Ê∏ÖÁêÜÊó•Âøó"
          sudo rm -rf /var/log/*

          echo ">>> ÂΩìÂâçÁ£ÅÁõòÁ©∫Èó¥"
          df -hT

      - name: Êâ©ÂÆπ /tmp Âà∞ 4GB
        run: |
          sudo rm -rf /tmp
          sudo mkdir /tmp
          sudo mount -t tmpfs -o size=4G tmpfs /tmp
          echo ">>> ÂΩìÂâçÁ£ÅÁõòÁ©∫Èó¥"
          df -hT

      - name: ÂÖãÈöÜÊ∫êÁ†Å
        working-directory: /workdir
        run: |
          git clone $REPO_URL -b $REPO_BRANCH openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: ÂáÜÂ§á ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ matrix.device_model }}-${{ env.REPO_BRANCH }}
          restore-keys: |
            ccache-${{ matrix.device_model }}-
            ccache-

      - name: ÈÖçÁΩÆ ccache
        run: |
          # 1. Á°Æ‰øùÁõÆÂΩïÂ≠òÂú®
          mkdir -p ${{ env.CCACHE_DIR }}

          # 2. ËÆæÁΩÆÂÖ®Â±ÄÁéØÂ¢ÉÂèòÈáè (ÈùûÂ∏∏ÂÖ≥ÈîÆ)
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
          echo "PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV

          # 3. ccache ÊÄßËÉΩ‰ºòÂåñ
          ccache -M 5G
          ccache -o compression=true
          ccache -o hash_dir=false
          ccache -z # Ê∏ÖÁ©∫ÁªüËÆ°ÔºåÊü•ÁúãÊú¨Ê¨°ÂëΩ‰∏≠Áéá

          # 4. Âº∫Âà∂Êé•ÁÆ° OpenWrt ÁºñËØë‰ΩìÁ≥ª
          cd openwrt
          echo "CONFIG_CCACHE=y" >> .config

          # ‰øÆÊ≠£ OpenWrt ÂÜÖÈÉ®ÂØπ CCACHE_DIR ÁöÑÁ°¨ÁºñÁ†ÅÂÆö‰πâ
          if [ -f include/shell.mk ]; then
            sed -i "s|CCACHE_DIR:=.*|CCACHE_DIR:=${{ env.CCACHE_DIR }}|g" include/shell.mk
          fi

      - name: ÁîüÊàêÊ∫ê‰ªìÂ∫ìÊõ¥Êñ∞Êó•Âøó & SOURCE_COMMIT_URL
        run: |
          if [ -f last_checked_sha.txt ]; then
            LAST_CHECKED_SHA=$(cat last_checked_sha.txt)
          else
            LAST_CHECKED_SHA=""
          fi
          cd /workdir/openwrt
          if [ -n "$LAST_CHECKED_SHA" ]; then
            TEMP_FILE=$(mktemp)
            git log $LAST_CHECKED_SHA..HEAD --pretty=format:"%s" | awk '!a[$0]++' | sed 's/^/- /' > "$TEMP_FILE"
            echo "CHECKED_COMMIT_MSGS_FILE=$TEMP_FILE" >> $GITHUB_ENV
            echo "Ê∫ê‰ªìÂ∫ìÊõ¥Êñ∞‰ø°ÊÅØ:"
            cat "$TEMP_FILE"
          else
            echo "Ê∫ê‰ªìÂ∫ìÊó†Êõ¥Êñ∞"
          fi
          echo "$(git rev-parse HEAD)" > /workdir/last_checked_sha.txt
          CURRENT_SHA=$(git rev-parse HEAD)
          COMMIT_URL="${REPO_URL}/commit/${CURRENT_SHA}"
          echo "ÂΩìÂâçÊ∫êÁ†ÅÊèê‰∫§ÈìæÊé•: $COMMIT_URL"
          # ÂÜôÂÖ•ÁéØÂ¢ÉÂèòÈáèÔºà‰æõÂêéÁª≠Ê≠•È™§‰ΩøÁî®Ôºâ
          echo "SOURCE_COMMIT_URL=$COMMIT_URL" >> $GITHUB_ENV

      - name: ÁßªÂä® last_checked_sha Âà∞Ê†πÁõÆÂΩï
        run: |
          mv /workdir/last_checked_sha.txt ./last_checked_sha.txt || true
          [ -f last_checked_sha.txt ] && cat last_checked_sha.txt || true

      - name: Âä†ËΩΩ Feeds & DIY1
        timeout-minutes: 15
        run: |
          [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
          chmod +x $DIY_P1_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P1_SH

      - name: Êõ¥Êñ∞ Feeds
        timeout-minutes: 30
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: ÂÆâË£ÖiStoreÂïÜÂ∫ó
        if: (github.event.inputs.istore == 'true')
        run: |
          cd openwrt
          echo >> feeds.conf.default
          echo 'src-git istore https://github.com/linkease/istore;main' >> feeds.conf.default
          ./scripts/feeds update istore
          ./scripts/feeds install -d y -p istore luci-app-store

      - name: Âä†ËΩΩÈÖçÁΩÆ & DIY2
        run: |
          [ -e files ] && mv files openwrt/files
          [ -e config/$CONFIG_FILE ] && mv config/$CONFIG_FILE openwrt/.config
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_${{ matrix.device_model }}=y" >> openwrt/.config
          echo "CONFIG_CCACHE=y" >> openwrt/.config
          chmod +x $DIY_P2_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P2_SH

      - name: Ê≥®ÂÖ• OpenClash
        if: env.ENABLE_OPENCLASH == 'true'
        run: |
          cd openwrt
          cat $GITHUB_WORKSPACE/config/openclash.config >> .config

      - name: ÁºñËØëÂü∫Á°ÄÂõ∫‰ª∂
        run: |
          set -e
          cd openwrt
          sed -i '/RUST\|sing-box\|alist\|ripgrep\|fd\|btop\|zellij\|starship\|exa/d' .config
          make defconfig
          make download -j$(nproc)
          make -j$(nproc) || make -j4 || make -j1 V=s
          df -hT

      - name: ËæìÂá∫ ccache ÁªüËÆ°
        run: |
          ccache -s
          du -sh ${{ env.CCACHE_DIR }}

      - name: Êï¥ÁêÜÂü∫Á°ÄÂõ∫‰ª∂Âπ∂‰∏ä‰º†
        shell: bash
        run: |
          cd openwrt/bin/targets/*/*
          mkdir -p $GITHUB_WORKSPACE/firmware-base
          cp -r . $GITHUB_WORKSPACE/firmware-base/

      - name: ‰øùÂ≠òË∑® Job ÂèòÈáè
        run: |
          cd openwrt

          # ‰øùÂ≠òÊú¨‰ªìÂ∫ì commit ‰ø°ÊÅØ
          if [ -n "$BUILD_COMMIT_MSGS_FILE" ] && [ -f "$BUILD_COMMIT_MSGS_FILE" ]; then
            cp "$BUILD_COMMIT_MSGS_FILE" build_commit_msgs.txt
          else
            echo "" > build_commit_msgs.txt
          fi

          # ‰øùÂ≠òÊ∫ê‰ªìÂ∫ì commit ‰ø°ÊÅØ
          if [ -n "$CHECKED_COMMIT_MSGS_FILE" ] && [ -f "$CHECKED_COMMIT_MSGS_FILE" ]; then
            cp "$CHECKED_COMMIT_MSGS_FILE" checked_commit_msgs.txt
          else
            echo "" > checked_commit_msgs.txt
          fi

          # ‰øùÂ≠òÊ∫êÁ†ÅÊèê‰∫§ÈìæÊé•
          echo "${SOURCE_COMMIT_URL:-}" > source_commit_url.txt

          # ‰øùÂ≠òËß¶ÂèëÊñπÂºè
          echo "${EVENT_TRIGGER_METHOD:-}" > event_trigger_method.txt

      - name: ‰∏ä‰º†Âü∫Á°ÄÂõ∫‰ª∂
        uses: actions/upload-artifact@v4
        with:
          name: firmware-base-${{ matrix.device_model }}
          path: firmware-base

      - name: Ê∏ÖÁêÜÊûÑÂª∫ÁõÆÂΩï‰ΩìÁßØ
        run: |
          cd openwrt
          rm -rf build_dir/target-* build_dir/toolchain-* staging_dir/target-* staging_dir/toolchain-* tmp bin logs
          df -hT

      - name: ‰∏ä‰º†Âü∫Á°ÄÊûÑÂª∫ÁéØÂ¢É
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-base-${{ matrix.device_model }}
          path: openwrt

# ==========================================
# Job3ÔºöÂèØÈÄâÂ¢ûÂº∫ÁºñËØë
# ==========================================
  build-enhanced:
    needs: build-base
    if: needs.build-base.outputs.need_second_build == 'true'
    runs-on: ubuntu-22.04
    name: ÁºñËØëÊúÄÁªàÂõ∫‰ª∂ - ${{ matrix.device_model }}
    strategy:
      matrix:
        device_model: ${{ github.event.inputs.device_model && fromJSON(format('["{0}"]', github.event.inputs.device_model)) || fromJSON('["cmcc_rax3000m"]') }}
      max-parallel: 1
    steps:
      - name: ‰∏ãËΩΩÂü∫Á°ÄÊûÑÂª∫ÁéØÂ¢É
        uses: actions/download-artifact@v4
        with:
          name: openwrt-base-${{ matrix.device_model }}
          path: .

      - name: ÊÅ¢Â§çË∑® Job ÂèòÈáè
        run: |
          cd openwrt

          # ÊÅ¢Â§çÊú¨‰ªìÂ∫ì commit ‰ø°ÊÅØ
          if [ -f build_commit_msgs.txt ]; then
            echo "BUILD_COMMIT_MSGS_FILE=$(pwd)/build_commit_msgs.txt" >> $GITHUB_ENV
          fi

          # ÊÅ¢Â§çÊ∫ê‰ªìÂ∫ì commit ‰ø°ÊÅØ
          if [ -f checked_commit_msgs.txt ]; then
            echo "CHECKED_COMMIT_MSGS_FILE=$(pwd)/checked_commit_msgs.txt" >> $GITHUB_ENV
          fi

          # ÊÅ¢Â§çÊ∫êÁ†ÅÊèê‰∫§ÈìæÊé•
          if [ -f source_commit_url.txt ]; then
            echo "SOURCE_COMMIT_URL=$(cat source_commit_url.txt)" >> $GITHUB_ENV
          fi

          # ÊÅ¢Â§çËß¶ÂèëÊñπÂºè
          if [ -f event_trigger_method.txt ]; then
            echo "EVENT_TRIGGER_METHOD=$(cat event_trigger_method.txt)" >> $GITHUB_ENV
          fi

      - name: Ê≥®ÂÖ• keepalived Á≠âËá™ÂÆö‰πâÈÖçÁΩÆ
        run: |
          cd openwrt
          inject_config() {
            local file="$1"
            echo ">>> Ê≥®ÂÖ•ÈÖçÁΩÆÊñá‰ª∂: $file"
            while IFS= read -r line; do
              [[ -z "$line" || "$line" =~ ^# ]] && continue
              opt=$(echo "$line" | cut -d= -f1)
              val=$(echo "$line" | cut -d= -f2)
              sed -i "/^$opt=/d" .config
              echo "$opt=$val" >> .config
            done < "$file"
          }
          [ "$ENABLE_WECHATPUSH" = "true" ] && inject_config "$GITHUB_WORKSPACE/config/wechatpush.config"
          [ "$ENABLE_KEEPALIVED" = "true" ] && inject_config "$GITHUB_WORKSPACE/config/keepalived.config"

          # Rust Á¶ÅÁî®
          inject_config "$GITHUB_WORKSPACE/config/rust_disable.config"

      - name: Ê∑ªÂä† keepalived-ha Êèí‰ª∂
        if: env.ENABLE_KEEPALIVED == 'true'
        run: |
          cd openwrt
          git clone --depth=1 https://github.com/PlanetEditorX/luci-app-build.git
          mkdir -p package/luci-app-keepalived-ha
          cp -r luci-app-build/luci-app-keepalived-ha/* package/luci-app-keepalived-ha/
          echo ">>> Ê£ÄÊü• keepalived-ha ÊòØÂê¶ÂêØÁî®Ôºö"
          grep luci-app-keepalived-ha .config || echo "‚ùå keepalived-ha Êú™ÂêØÁî®"

      - name: ÁºñËØëÊúÄÁªàÂõ∫‰ª∂
        id: compile
        run: |
          set -e
          cd openwrt
          make defconfig
          echo ">>> Ê£ÄÊü• Rust ÊòØÂê¶Ë¢´Á¶ÅÁî®Ôºö"
          grep -E "RUST|sing-box|alist|ripgrep|fd|btop|zellij|exa" .config || echo "Rust Â∑≤ÂÆåÂÖ®Á¶ÅÁî®"
          make download -j$(nproc)
          make -j$(nproc) || make -j4 || make -j1 V=s

      - name: Êï¥ÁêÜÊúÄÁªàÂõ∫‰ª∂
        shell: bash
        run: |
          cd openwrt/bin/targets/*/*
          mkdir -p $GITHUB_WORKSPACE/firmware-final
          cp -r . $GITHUB_WORKSPACE/firmware-final/

      - name: ‰∏ä‰º†ÊúÄÁªàÂõ∫‰ª∂
        uses: actions/upload-artifact@v4
        with:
          name: firmware-final-${{ matrix.device_model }}
          path: firmware-final

# ==========================================
# Job4Ôºö‰∏ä‰º† / ÂèëÂ∏É Release
# ==========================================
  upload-release:
    needs:
      - build-base
      - build-enhanced
    runs-on: ubuntu-22.04
    name: ‰∏ä‰º†Âõ∫‰ª∂Âπ∂ÂèëÂ∏É ${{ matrix.device_model }} Release
    strategy:
      matrix:
        device_model: ${{ github.event.inputs.device_model && fromJSON(format('["{0}"]', github.event.inputs.device_model)) || fromJSON('["cmcc_rax3000m"]') }}
      max-parallel: 1
    steps:
      - name: Ê£ÄÂá∫Êú¨‰ªìÂ∫ì‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‰∏ãËΩΩÂü∫Á°ÄÊûÑÂª∫ÁéØÂ¢ÉÔºàËé∑ÂèñÂÖÉÊï∞ÊçÆÔºâ
        uses: actions/download-artifact@v4
        with:
          name: openwrt-base-${{ matrix.device_model }}
          path: ./openwrt-meta

      - name: ÊÅ¢Â§çË∑® Job ÂèòÈáèÔºà‰ªéÂü∫Á°ÄÊûÑÂª∫ÁéØÂ¢ÉÔºâ
        run: |
          cd openwrt-meta
          if [ -f build_commit_msgs.txt ]; then
            echo "BUILD_COMMIT_MSGS_FILE=$(pwd)/build_commit_msgs.txt" >> $GITHUB_ENV
          fi
          if [ -f checked_commit_msgs.txt ]; then
            echo "CHECKED_COMMIT_MSGS_FILE=$(pwd)/checked_commit_msgs.txt" >> $GITHUB_ENV
          fi
          if [ -f source_commit_url.txt ]; then
            echo "SOURCE_COMMIT_URL=$(cat source_commit_url.txt)" >> $GITHUB_ENV
          fi
          if [ -f event_trigger_method.txt ]; then
            echo "EVENT_TRIGGER_METHOD=$(cat event_trigger_method.txt)" >> $GITHUB_ENV
          fi

      - name: Â∞ùËØï‰∏ãËΩΩÊúÄÁªàÂõ∫‰ª∂
        id: dl_final
        uses: actions/download-artifact@v4
        with:
          name: firmware-final-${{ matrix.device_model }}
          path: firmware
        continue-on-error: true

      - name: Â¶ÇÊûúÊúÄÁªàÂõ∫‰ª∂‰∏çÂ≠òÂú®ÔºåÂõûÈÄÄÂà∞Âü∫Á°ÄÂõ∫‰ª∂
        if: steps.dl_final.outcome != 'success'
        uses: actions/download-artifact@v4
        with:
          name: firmware-base-${{ matrix.device_model }}
          path: firmware

      - name: ËßÑËåÉÂõ∫‰ª∂ÂëΩÂêç
        run: |
          cd firmware/targets/*/* || cd firmware   # ÂÖºÂÆπ‰∏çÂêåÁõÆÂΩïÁªìÊûÑ
          DEVICE_MODEL="${{ matrix.device_model }}"

          # Â∞ùËØï‰ªé openwrt-meta Ëé∑ÂèñÊ∫êÁ†ÅÁâàÊú¨
          if [ -d "$GITHUB_WORKSPACE/openwrt-meta/.git" ]; then
            cd "$GITHUB_WORKSPACE/openwrt-meta"
            VERSION=$(git rev-parse --short HEAD || echo "unknown")
          else
            VERSION=$(git rev-parse --short HEAD || echo "unknown")
          fi
          SAFE_VERSION="r${VERSION}"
          echo "FIRMWARE_VERSION=$SAFE_VERSION" >> $GITHUB_ENV

          FILE_DATE="_$(date +'%Y%m%d%H%M')"
          echo "FILE_DATE=$FILE_DATE" >> $GITHUB_ENV

          for file in *sysupgrade* *factory*; do
            [ -f "$file" ] || continue
            TYPE=$(echo "$file" | grep -o "sysupgrade\|factory" || echo "img")
            EXT="${file##*.}"
            NEW_NAME="${DEVICE_MODEL}_${SAFE_VERSION}${FILE_DATE}_${TYPE}.${EXT}"
            mv "$file" "$NEW_NAME"
          done

          echo "FIRMWARE=$(pwd)" >> $GITHUB_ENV
          ls -la

      - name: ‰∏ä‰º† bin ÁõÆÂΩïÔºàÂèØÈÄâÔºâ
        if: env.UPLOAD_FIRMWARE == 'true' && github.event.inputs.upload_bin_dir == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt_bin_${{ matrix.device_model }}${{ env.FILE_DATE }}
          path: firmware

      - name: ÁîüÊàê Release ÊèèËø∞Êñá‰ª∂
        run: |
          set -e
          if [ -z "${{ env.FIRMWARE_VERSION }}" ]; then
            echo "Missing FIRMWARE_VERSION"
            exit 1
          fi
          TAG="ImmortalWrt-24.10-${{ matrix.device_model }}-${{ env.FIRMWARE_VERSION }}"
          echo "RELEASE_TAG=$TAG-$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV

          {
            echo "## üì¶ Âõ∫‰ª∂‰ø°ÊÅØ"
            echo "Âõ∫‰ª∂ÁâàÊú¨: ImmortalWrt ${{ env.FIRMWARE_VERSION }}"
            echo "ËÆæÂ§áÂûãÂè∑: ${{ matrix.device_model }}"
            echo "ÁºñËØëÊó∂Èó¥: $(date +'%Y-%m-%d %H:%M %Z')"
            echo "ÂêéÂè∞Âú∞ÂùÄ: 192.168.2.1 Êàñ http://immortalwrt.lan/"
            echo "Ê∫ê‰ª£Á†Å‰ªìÂ∫ì: $REPO_URL"
            echo "Ê∫ê‰ªìÂ∫ìÂàÜÊîØ: $REPO_BRANCH"
            echo "Ê∫ê‰ªìÂ∫ìÊèê‰∫§: [Êü•ÁúãÁºñËØëÊó∂Êèê‰∫§](${SOURCE_COMMIT_URL:-Êú™Áü•})"
            echo "ÈÖçÁΩÆÊñá‰ª∂: $CONFIG_FILE"
            echo "Ëß¶ÂèëÊñπÂºè: ${EVENT_TRIGGER_METHOD:-unknown}"

            if { [ -n "$BUILD_COMMIT_MSGS_FILE" ] && [ -s "$BUILD_COMMIT_MSGS_FILE" ]; } || \
                { [ -n "$CHECKED_COMMIT_MSGS_FILE" ] && [ -s "$CHECKED_COMMIT_MSGS_FILE" ]; }; then
              echo ""
              echo "## üìù Êõ¥Êñ∞ÂÜÖÂÆπ"
              if [ -n "$BUILD_COMMIT_MSGS_FILE" ] && [ -s "$BUILD_COMMIT_MSGS_FILE" ]; then
                echo "### üìå Êú¨‰ªìÂ∫ìÊõ¥Êñ∞"
                cat "$BUILD_COMMIT_MSGS_FILE"
              fi
              if [ -n "$CHECKED_COMMIT_MSGS_FILE" ] && [ -s "$CHECKED_COMMIT_MSGS_FILE" ]; then
                echo "### üìå Ê∫ê‰ªìÂ∫ìÊõ¥Êñ∞"
                cat "$CHECKED_COMMIT_MSGS_FILE"
              fi
            fi

            echo ""
            echo "## üîß Âà∑Êú∫ËØ¥Êòé"
            echo "1. ‰ΩøÁî® sysupgrade Âõ∫‰ª∂ËøõË°åÂçáÁ∫ß„ÄÇ"
            echo "2. Ëã•ÂêØÁî®‰∫Ü‚Äú‰∏ä‰º†ÊâÄÊúâÊñá‰ª∂‚ÄùÔºåËØ∑Ë∞®ÊÖé‰ΩøÁî® GPT„ÄÅpreloader„ÄÅFIP Á≠âÊñá‰ª∂ÔºåÂÆÉ‰ª¨‰ªÖÁî®‰∫éÂ∫ïÂ±ÇÊÅ¢Â§ç„ÄÇ"
            echo "3. Â¶ÇÈúÄÊïëÁ†ñÔºåÂèØ‰ΩøÁî® initramfs-recovery ‰ªé U-Boot ÂêØÂä®ÊÅ¢Â§çÁ≥ªÁªü„ÄÇ"
          } > release

          cat release

      - name: ÂèëÂ∏É Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          body_path: release
          files: |
            ${{ env.UPLOAD_ALL_FILES == 'true' && format('{0}/*', env.FIRMWARE) || format('{0}/*sysupgrade*.*', env.FIRMWARE) }}

      - name: ‰øùÂ≠òÊ≠§Ê¨°Êèê‰∫§ shaÔºàÊú¨‰ªìÂ∫ìÔºâ
        run: |
          echo "$(git rev-parse HEAD)" > last_build_sha.txt

      - name: ‰øùÂ≠ò last_build_sha ÁºìÂ≠ò
        uses: actions/cache@v4
        with:
          path: last_build_sha.txt
          key: ${{ env.REPO_PATH }}-${{ env.REPO_BRANCH }}-last-build-sha
